"use strict";
var IndustryRepository = require("../dataaccess/repository/import-industries.repository");
var xlsxj = require('xlsx-to-json');
var CNextMessages = require("../shared/cnext-messages");
var ProjectAsset = require("../shared/projectasset");
var ImportIndustriesModel = require("../dataaccess/model/industry-class.model");
var IndustryService = require("./industry.service");
var RoleService = require("./role.service");
var CapabilityService = require("./capability.service");
var ComplexityService = require("./complexity.service");
var Messages = require("../shared/messages");
var RolesService = new RoleService();
var CapabilitiesService = new CapabilityService();
var ComplexitiesService = new ComplexityService();
var ImportIndustryService = (function () {
    function ImportIndustryService() {
        this.importIndustriesRepository = new IndustryRepository();
        this.APP_NAME = ProjectAsset.APP_NAME;
    }
    ImportIndustryService.prototype.create = function (item, callback) {
        var industryService;
        industryService = new IndustryService();
        industryService.create(item, function (errinCreate, response) {
            if (errinCreate) {
                callback(new Error(CNextMessages.PROBLEM_IN_CREATING_INDUSTRY), null);
            }
            else {
                if (response.length === 0) {
                    callback('Empty Response', null);
                }
                else {
                    callback(null, response);
                }
            }
        });
    };
    ImportIndustryService.prototype.readXlsx = function (filePath, callback) {
        xlsxj({
            input: filePath,
            output: null
        }, function (err, result) {
            var isSend = false;
            if (err) {
                console.error(err);
                callback(err, null);
            }
            else {
                var rolesArray = [];
                for (var i = 0; i < result.length - 1; i++) {
                    if (result[i].area_of_work_code === '') {
                        if (result[i].area_of_work_code === '' && result[i].capability === '' && result[i].complexity === '') {
                        }
                        else {
                            if (!isSend) {
                                isSend = true;
                                callback(new Error(Messages.MSG_ERROR_AREA_OF_WORK_CODE_MISSING + ' - ' + result[i].area_of_work), null);
                            }
                        }
                    }
                    rolesArray = RolesService.addRole(result[i], rolesArray);
                }
                for (var i = 0; i < rolesArray.length; i++) {
                    var capabilities = [];
                    for (var j = 1; j < result.length; j++) {
                        var currentRow = result[j];
                        if (rolesArray[i].name === currentRow.area_of_work) {
                            if (result[j].capability_code === '') {
                                if (result[j].area_of_work === '' && result[j].capability === '' && result[j].complexity === '') {
                                }
                                else {
                                    console.log(' role name ' + i + result[i].area_of_work);
                                    if (!isSend) {
                                        isSend = true;
                                        callback(new Error(Messages.MSG_ERROR_CAPABILITY_CODE_MISSING + ' - ' + result[j].capability), null);
                                    }
                                }
                            }
                            capabilities = CapabilitiesService.addCapabilities(result[j], capabilities);
                        }
                        else {
                            rolesArray[i].capabilities = capabilities;
                        }
                    }
                }
                for (var i = 0; i < rolesArray.length; i++) {
                    for (var capIndex = 0; capIndex < rolesArray[i].capabilities.length; capIndex++) {
                        var complexities = [];
                        for (var j = 0; j < result.length; j++) {
                            var currentRow_1 = result[j];
                            if (rolesArray[i].name === currentRow_1.area_of_work) {
                                if (rolesArray[i].capabilities[capIndex].name === currentRow_1.capability) {
                                    if (result[j].complexity_code === '') {
                                        if (result[j].area_of_work === '' && result[j].capability === '' && result[j].complexity === '') {
                                        }
                                        else {
                                            console.log(' role name ' + i + result[i].area_of_work);
                                            if (!isSend) {
                                                isSend = true;
                                                callback(new Error(Messages.MSG_ERROR_COMPLEXITY_CODE_MISSING + ' - ' + result[j].complexity), null);
                                            }
                                        }
                                    }
                                    complexities = ComplexitiesService.addComplexities(result[j], complexities);
                                }
                            }
                        }
                        rolesArray[i].capabilities[capIndex].complexities = complexities;
                    }
                }
                for (var i = 0; i < rolesArray.length; i++) {
                    rolesArray[i].default_complexities = new Array(0);
                    var temp = new Array(0);
                    for (var c in rolesArray[i].capabilities) {
                        if (rolesArray[i].capabilities[c].code.startsWith('d')) {
                            var tempCode = rolesArray[i].capabilities[c].code.split("d")[1];
                            rolesArray[i].capabilities[c].code = tempCode;
                            rolesArray[i].default_complexities.push(rolesArray[i].capabilities[c]);
                            temp.push(c);
                        }
                    }
                    if (temp.length > 0) {
                        for (var t = temp.length - 1; t >= 0; t--) {
                            rolesArray[i].capabilities.splice(temp[t], 1);
                        }
                    }
                    if (rolesArray[i].name === '') {
                        rolesArray.splice(i, 1);
                    }
                }
                var industry = new ImportIndustriesModel(result[0].industry, result[0].code, result[0].sort_order, rolesArray);
                if (!isSend) {
                    if (result[0].code === '' || result[0].sort_order === '' || result[0].code === undefined || result[0].sort_order === undefined) {
                        callback(new Error(Messages.MSG_ERROR_INDUSTRY_CODE_OR_SORT_NUMBER_MISSING + ' - ' + result[0].industry), null);
                    }
                    callback(null, industry);
                }
            }
        });
    };
    return ImportIndustryService;
}());
Object.seal(ImportIndustryService);
module.exports = ImportIndustryService;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC9mcmFtZXdvcmsvc2VydmljZXMvaW1wb3J0LWluZHVzdHJpZXMuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsMEZBQTZGO0FBSTdGLElBQUksS0FBSyxHQUFHLE9BQU8sQ0FBQyxjQUFjLENBQUMsQ0FBQztBQUNwQyx3REFBMkQ7QUFDM0QscURBQXdEO0FBQ3hELGdGQUFtRjtBQUNuRixvREFBdUQ7QUFDdkQsNENBQStDO0FBQy9DLHdEQUEyRDtBQUMzRCx3REFBMkQ7QUFDM0QsNkNBQWdEO0FBRWhELElBQUksWUFBWSxHQUFHLElBQUksV0FBVyxFQUFFLENBQUM7QUFDckMsSUFBSSxtQkFBbUIsR0FBRyxJQUFJLGlCQUFpQixFQUFFLENBQUM7QUFDbEQsSUFBSSxtQkFBbUIsR0FBRyxJQUFJLGlCQUFpQixFQUFFLENBQUM7QUFFbEQ7SUFJRTtRQUNFLElBQUksQ0FBQywwQkFBMEIsR0FBRyxJQUFJLGtCQUFrQixFQUFFLENBQUM7UUFDM0QsSUFBSSxDQUFDLFFBQVEsR0FBRyxZQUFZLENBQUMsUUFBUSxDQUFDO0lBQ3hDLENBQUM7SUFFRCxzQ0FBTSxHQUFOLFVBQU8sSUFBUyxFQUFFLFFBQTJDO1FBRTNELElBQUksZUFBaUMsQ0FBQztRQUN0QyxlQUFlLEdBQUcsSUFBSSxlQUFlLEVBQUUsQ0FBQztRQUN4QyxlQUFlLENBQUMsTUFBTSxDQUFDLElBQUksRUFBQyxVQUFDLFdBQWdCLEVBQUUsUUFBYTtZQUMxRCxFQUFFLENBQUMsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDO2dCQUNoQixRQUFRLENBQUMsSUFBSSxLQUFLLENBQUMsYUFBYSxDQUFDLDRCQUE0QixDQUFDLEVBQUUsSUFBSSxDQUFDLENBQUM7WUFDeEUsQ0FBQztZQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNOLEVBQUUsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxNQUFNLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztvQkFDMUIsUUFBUSxDQUFDLGdCQUFnQixFQUFF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Qyw4Q0FBOEMsR0FBQyxLQUFLLEdBQUcsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDO29CQUNoSCxDQUFDO29CQUNELFFBQVEsQ0FBQyxJQUFJLEVBQUUsUUFBUSxDQUFDLENBQUM7Z0JBQzNCLENBQUM7WUFDSCxDQUFDO1FBQ0gsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBQ0gsNEJBQUM7QUFBRCxDQWxKQSxBQWtKQyxJQUFBO0FBRUQsTUFBTSxDQUFDLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO0FBQ25DLGlCQUFTLHFCQUFxQixDQUFDIiwiZmlsZSI6ImFwcC9mcmFtZXdvcmsvc2VydmljZXMvaW1wb3J0LWluZHVzdHJpZXMuc2VydmljZS5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBJbmR1c3RyeVJlcG9zaXRvcnkgPSByZXF1aXJlKCcuLi9kYXRhYWNjZXNzL3JlcG9zaXRvcnkvaW1wb3J0LWluZHVzdHJpZXMucmVwb3NpdG9yeScpO1xyXG4vKipcclxuICogQ3JlYXRlZCBieSB0ZWNocHJpbWUwMDIgb24gNy8xMS8yMDE3LlxyXG4gKi9cclxudmFyIHhsc3hqID0gcmVxdWlyZSgneGxzeC10by1qc29uJyk7XHJcbmltcG9ydCBDTmV4dE1lc3NhZ2VzID0gcmVxdWlyZSgnLi4vc2hhcmVkL2NuZXh0LW1lc3NhZ2VzJyk7XHJcbmltcG9ydCBQcm9qZWN0QXNzZXQgPSByZXF1aXJlKCcuLi9zaGFyZWQvcHJvamVjdGFzc2V0Jyk7XHJcbmltcG9ydCBJbXBvcnRJbmR1c3RyaWVzTW9kZWwgPSByZXF1aXJlKCcuLi9kYXRhYWNjZXNzL21vZGVsL2luZHVzdHJ5LWNsYXNzLm1vZGVsJyk7XHJcbmltcG9ydCBJbmR1c3RyeVNlcnZpY2UgPSByZXF1aXJlKCcuL2luZHVzdHJ5LnNlcnZpY2UnKTtcclxuaW1wb3J0IFJvbGVTZXJ2aWNlID0gcmVxdWlyZSgnLi9yb2xlLnNlcnZpY2UnKTtcclxuaW1wb3J0IENhcGFiaWxpdHlTZXJ2aWNlID0gcmVxdWlyZSgnLi9jYXBhYmlsaXR5LnNlcnZpY2UnKTtcclxuaW1wb3J0IENvbXBsZXhpdHlTZXJ2aWNlID0gcmVxdWlyZSgnLi9jb21wbGV4aXR5LnNlcnZpY2UnKTtcclxuaW1wb3J0IE1lc3NhZ2VzID0gcmVxdWlyZSgnLi4vc2hhcmVkL21lc3NhZ2VzJyk7XHJcblxyXG5sZXQgUm9sZXNTZXJ2aWNlID0gbmV3IFJvbGVTZXJ2aWNlKCk7XHJcbmxldCBDYXBhYmlsaXRpZXNTZXJ2aWNlID0gbmV3IENhcGFiaWxpdHlTZXJ2aWNlKCk7XHJcbmxldCBDb21wbGV4aXRpZXNTZXJ2aWNlID0gbmV3IENvbXBsZXhpdHlTZXJ2aWNlKCk7XHJcblxyXG5jbGFzcyBJbXBvcnRJbmR1c3RyeVNlcnZpY2Uge1xyXG4gIEFQUF9OQU1FOiBzdHJpbmc7XHJcbiAgcHJpdmF0ZSBpbXBvcnRJbmR1c3RyaWVzUmVwb3NpdG9yeTogSW5kdXN0cnlSZXBvc2l0b3J5O1xyXG5cclxuICBjb25zdHJ1Y3RvcigpIHtcclxuICAgIHRoaXMuaW1wb3J0SW5kdXN0cmllc1JlcG9zaXRvcnkgPSBuZXcgSW5kdXN0cnlSZXBvc2l0b3J5KCk7XHJcbiAgICB0aGlzLkFQUF9OQU1FID0gUHJvamVjdEFzc2V0LkFQUF9OQU1FO1xyXG4gIH1cclxuXHJcbiAgY3JlYXRlKGl0ZW06IGFueSwgY2FsbGJhY2s6IChlcnJvcjogYW55LCByZXN1bHQ6IGFueSkgPT4gdm9pZCkge1xyXG5cclxuICAgIGxldCBpbmR1c3RyeVNlcnZpY2UgOiBJbmR1c3RyeVNlcnZpY2U7XHJcbiAgICBpbmR1c3RyeVNlcnZpY2UgPSBuZXcgSW5kdXN0cnlTZXJ2aWNlKCk7XHJcbiAgICBpbmR1c3RyeVNlcnZpY2UuY3JlYXRlKGl0ZW0sKGVycmluQ3JlYXRlOiBhbnksIHJlc3BvbnNlOiBhbnkpID0+IHtcclxuICAgICAgaWYgKGVycmluQ3JlYXRlKSB7XHJcbiAgICAgICAgY2FsbGJhY2sobmV3IEVycm9yKENOZXh0TWVzc2FnZXMuUFJPQkxFTV9JTl9DUkVBVElOR19JTkRVU1RSWSksIG51bGwpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGlmIChyZXNwb25zZS5sZW5ndGggPT09IDApIHtcclxuICAgICAgICAgIGNhbGxiYWNrKCdFbXB0eSBSZXNwb25zZScsIG51bGwpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICBjYWxsYmFjayhudWxsLCByZXNwb25zZSk7XHJcbiAgICAgICAgICAvL3RoaXMuaW1wb3J0SW5kdXN0cmllc1JlcG9zaXRvcnkuZmluZE9uZUFuZFVwZGF0ZSh7J19pZCc6IHJlc3BvbnNlWzBdLl9pZH0sIGl0ZW0sIHtuZXc6IHRydWV9LCBjYWxsYmFjayk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHJlYWRYbHN4KGZpbGVQYXRoOnN0cmluZywgY2FsbGJhY2s6KGVycm9yOmFueSwgcmVzdWx0OmFueSkgPT4gdm9pZCkge1xyXG4gICAgeGxzeGooe1xyXG4gICAgICBpbnB1dDogZmlsZVBhdGgsXHJcbiAgICAgIG91dHB1dDogbnVsbFxyXG4gICAgfSwgZnVuY3Rpb24gKGVycjphbnksIHJlc3VsdDphbnkpIHtcclxuICAgICAgbGV0IGlzU2VuZCA6IGJvb2xlYW4gPWZhbHNlO1xyXG4gICAgICBpZiAoZXJyKSB7XHJcbiAgICAgICAgY29uc29sZS5lcnJvcihlcnIpO1xyXG4gICAgICAgIGNhbGxiYWNrKGVyciwgbnVsbCk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgdmFyIHJvbGVzQXJyYXk6YW55ID0gW107XHJcblxyXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcmVzdWx0Lmxlbmd0aC0xOyBpKyspIHtcclxuICAgICAgICAgIGlmKHJlc3VsdFtpXS5hcmVhX29mX3dvcmtfY29kZSA9PT0gJycpIHtcclxuICAgICAgICAgICAgaWYocmVzdWx0W2ldLmFyZWFfb2Zfd29ya19jb2RlID09PSAnJyAmJiByZXN1bHRbaV0uY2FwYWJpbGl0eSA9PT0nJyAmJiByZXN1bHRbaV0uY29tcGxleGl0eT09PScnKSB7XHJcbiAgICAgICAgICAgIH1lbHNlIHtcclxuICAgICAgICAgICAgICBpZighaXNTZW5kKSB7XHJcbiAgICAgICAgICAgICAgICBpc1NlbmQ9dHJ1ZTtcclxuICAgICAgICAgICAgICAgIGNhbGxiYWNrKG5ldyBFcnJvcihNZXNzYWdlcy5NU0dfRVJST1JfQVJFQV9PRl9XT1JLX0NPREVfTUlTU0lORysnIC0gJytyZXN1bHRbaV0uYXJlYV9vZl93b3JrKSxudWxsKTtcclxuICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH1cclxuICAgICAgICAgIHJvbGVzQXJyYXkgPSBSb2xlc1NlcnZpY2UuYWRkUm9sZShyZXN1bHRbaV0sIHJvbGVzQXJyYXkpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCByb2xlc0FycmF5Lmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICB2YXIgY2FwYWJpbGl0aWVzOiBhbnkgPSBbXTtcclxuICAgICAgICAgIGZvciAobGV0IGogPSAxOyBqIDwgcmVzdWx0Lmxlbmd0aDsgaisrKSB7XHJcbiAgICAgICAgICAgIHZhciBjdXJyZW50Um93ID0gcmVzdWx0W2pdO1xyXG4gICAgICAgICAgICBpZiAocm9sZXNBcnJheVtpXS5uYW1lID09PSBjdXJyZW50Um93LmFyZWFfb2Zfd29yaykge1xyXG4gICAgICAgICAgICAgIGlmKHJlc3VsdFtqXS5jYXBhYmlsaXR5X2NvZGUgPT09ICcnKSB7XHJcbiAgICAgICAgICAgICAgICBpZihyZXN1bHRbal0uYXJlYV9vZl93b3JrID09PSAnJyAmJiByZXN1bHRbal0uY2FwYWJpbGl0eSA9PT0nJyAmJiByZXN1bHRbal0uY29tcGxleGl0eT09PScnKSB7XHJcbiAgICAgICAgICAgICAgICB9ZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCcgcm9sZSBuYW1lICcraStyZXN1bHRbaV0uYXJlYV9vZl93b3JrKTtcclxuICAgICAgICAgICAgICAgICAgaWYoIWlzU2VuZCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGlzU2VuZD10cnVlO1xyXG4gICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKG5ldyBFcnJvcihNZXNzYWdlcy5NU0dfRVJST1JfQ0FQQUJJTElUWV9DT0RFX01JU1NJTkcrJyAtICcrcmVzdWx0W2pdLmNhcGFiaWxpdHkpLG51bGwpO1xyXG4gICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgIGNhcGFiaWxpdGllcyA9IENhcGFiaWxpdGllc1NlcnZpY2UuYWRkQ2FwYWJpbGl0aWVzKHJlc3VsdFtqXSwgY2FwYWJpbGl0aWVzKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICByb2xlc0FycmF5W2ldLmNhcGFiaWxpdGllcyA9IGNhcGFiaWxpdGllcztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCByb2xlc0FycmF5Lmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICBmb3IgKGxldCBjYXBJbmRleCA9IDA7IGNhcEluZGV4IDwgcm9sZXNBcnJheVtpXS5jYXBhYmlsaXRpZXMubGVuZ3RoOyBjYXBJbmRleCsrKSB7XHJcbiAgICAgICAgICAgIGxldCBjb21wbGV4aXRpZXM6YW55ID0gW107XHJcbiAgICAgICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgcmVzdWx0Lmxlbmd0aDsgaisrKSB7XHJcbiAgICAgICAgICAgICAgbGV0IGN1cnJlbnRSb3cgPSByZXN1bHRbal07XHJcbiAgICAgICAgICAgICAgaWYgKHJvbGVzQXJyYXlbaV0ubmFtZSA9PT0gY3VycmVudFJvdy5hcmVhX29mX3dvcmspIHtcclxuICAgICAgICAgICAgICBpZiAocm9sZXNBcnJheVtpXS5jYXBhYmlsaXRpZXNbY2FwSW5kZXhdLm5hbWUgPT09IGN1cnJlbnRSb3cuY2FwYWJpbGl0eSkge1xyXG4gICAgICAgICAgICAgICAgaWYgKHJlc3VsdFtqXS5jb21wbGV4aXR5X2NvZGUgPT09ICcnKSB7XHJcbiAgICAgICAgICAgICAgICAgIGlmIChyZXN1bHRbal0uYXJlYV9vZl93b3JrID09PSAnJyAmJiByZXN1bHRbal0uY2FwYWJpbGl0eSA9PT0gJycgJiYgcmVzdWx0W2pdLmNvbXBsZXhpdHkgPT09ICcnKSB7XHJcbiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJyByb2xlIG5hbWUgJyArIGkgKyByZXN1bHRbaV0uYXJlYV9vZl93b3JrKTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoIWlzU2VuZCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgaXNTZW5kID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKG5ldyBFcnJvcihNZXNzYWdlcy5NU0dfRVJST1JfQ09NUExFWElUWV9DT0RFX01JU1NJTkcrJyAtICcgKyByZXN1bHRbal0uY29tcGxleGl0eSksIG51bGwpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgY29tcGxleGl0aWVzID0gQ29tcGxleGl0aWVzU2VydmljZS5hZGRDb21wbGV4aXRpZXMocmVzdWx0W2pdLCBjb21wbGV4aXRpZXMpO1xyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJvbGVzQXJyYXlbaV0uY2FwYWJpbGl0aWVzW2NhcEluZGV4XS5jb21wbGV4aXRpZXMgPSBjb21wbGV4aXRpZXM7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHJvbGVzQXJyYXkubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgIHJvbGVzQXJyYXlbaV0uZGVmYXVsdF9jb21wbGV4aXRpZXMgPSBuZXcgQXJyYXkoMCk7XHJcbiAgICAgICAgICBsZXQgdGVtcCA9IG5ldyBBcnJheSgwKTtcclxuICAgICAgICAgIGZvciAobGV0IGMgaW4gcm9sZXNBcnJheVtpXS5jYXBhYmlsaXRpZXMpIHtcclxuICAgICAgICAgICAgLy9pZihyb2xlc0FycmF5W2ldLm5hbWUgPT0gJ0lUIFN1cHBvcnQnKXtcclxuICAgICAgICAgICAgaWYgKHJvbGVzQXJyYXlbaV0uY2FwYWJpbGl0aWVzW2NdLmNvZGUuc3RhcnRzV2l0aCgnZCcpKSB7XHJcbiAgICAgICAgICAgICAgbGV0IHRlbXBDb2RlID0gcm9sZXNBcnJheVtpXS5jYXBhYmlsaXRpZXNbY10uY29kZS5zcGxpdChcImRcIilbMV07XHJcbiAgICAgICAgICAgICAgcm9sZXNBcnJheVtpXS5jYXBhYmlsaXRpZXNbY10uY29kZSA9IHRlbXBDb2RlO1xyXG4gICAgICAgICAgICAgIHJvbGVzQXJyYXlbaV0uZGVmYXVsdF9jb21wbGV4aXRpZXMucHVzaChyb2xlc0FycmF5W2ldLmNhcGFiaWxpdGllc1tjXSk7XHJcbiAgICAgICAgICAgICAgdGVtcC5wdXNoKGMpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIC8vfVxyXG4gICAgICAgICAgfVxyXG5cclxuICAgICAgICAgIGlmICh0ZW1wLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgZm9yIChsZXQgdCA9IHRlbXAubGVuZ3RoIC0gMTsgdCA+PSAwOyB0LS0pIHtcclxuICAgICAgICAgICAgICByb2xlc0FycmF5W2ldLmNhcGFiaWxpdGllcy5zcGxpY2UodGVtcFt0XSwgMSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH1cclxuXHJcblxyXG4gICAgICAgICAgaWYgKHJvbGVzQXJyYXlbaV0ubmFtZSA9PT0gJycpIHtcclxuICAgICAgICAgICAgcm9sZXNBcnJheS5zcGxpY2UoaSwgMSk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvKmZvciAobGV0IGkgPSAwOyBpIDwgcm9sZXNBcnJheS5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICByb2xlc0FycmF5W2ldLmRlZmF1bHRfY29tcGxleGl0aWVzID0gbmV3IEFycmF5KDApO1xyXG4gICAgICAgICAgaWYgKHJvbGVzQXJyYXlbaV0uY2FwYWJpbGl0aWVzWzBdLm5hbWUuc3RhcnRzV2l0aCgnRGVmYXVsdCcpKSB7XHJcbiAgICAgICAgICAgIHJvbGVzQXJyYXlbaV0uZGVmYXVsdF9jb21wbGV4aXRpZXMucHVzaChyb2xlc0FycmF5W2ldLmNhcGFiaWxpdGllc1swXSk7XHJcbiAgICAgICAgICAgIHJvbGVzQXJyYXlbaV0uY2FwYWJpbGl0aWVzLnNoaWZ0KCk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICBpZiAocm9sZXNBcnJheVtpXS5uYW1lID09PSAnJykge1xyXG4gICAgICAgICAgICByb2xlc0FycmF5LnNwbGljZShpLCAxKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgfSovXHJcblxyXG4gICAgICAgIGxldCBpbmR1c3RyeSA9IG5ldyBJbXBvcnRJbmR1c3RyaWVzTW9kZWwocmVzdWx0WzBdLmluZHVzdHJ5LCByZXN1bHRbMF0uY29kZSxyZXN1bHRbMF0uc29ydF9vcmRlcixyb2xlc0FycmF5KTtcclxuICAgICAgICBpZighaXNTZW5kKSB7XHJcbiAgICAgICAgICBpZihyZXN1bHRbMF0uY29kZT09PScnfHxyZXN1bHRbMF0uc29ydF9vcmRlcj09PScnfHxyZXN1bHRbMF0uY29kZT09PXVuZGVmaW5lZHx8cmVzdWx0WzBdLnNvcnRfb3JkZXI9PT11bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgY2FsbGJhY2sobmV3IEVycm9yKE1lc3NhZ2VzLk1TR19FUlJPUl9JTkRVU1RSWV9DT0RFX09SX1NPUlRfTlVNQkVSX01JU1NJTkcrJyAtICcgKyByZXN1bHRbMF0uaW5kdXN0cnkpLCBudWxsKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIGNhbGxiYWNrKG51bGwsIGluZHVzdHJ5KTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxufVxyXG5cclxuT2JqZWN0LnNlYWwoSW1wb3J0SW5kdXN0cnlTZXJ2aWNlKTtcclxuZXhwb3J0ID0gSW1wb3J0SW5kdXN0cnlTZXJ2aWNlO1xyXG4iXX0=
