"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var express = require("express");
var path = require("path");
var LoggerService = require("./app/framework/shared/logger/LoggerService");
var sharedService = require("./app/framework/shared/logger/shared.service");
var Middlewares = require("./app/framework/middlewares/base/MiddlewaresBase");
var RateAnalysisService = require("./app/applicationProject/services/RateAnalysisService");
var UserService = require("./app/framework/services/UserService");
var log4js = require('log4js');
var config = require('config');
var spdy = require('spdy');
__dirname = './';
var _clientDir = '/dist/client/dev';
var _serverDir = '/dist/server/dev';
var app = express();
var CronJob = require('cron').CronJob;
function init(port, mode, protocol, dist_runner) {
    var loggerConfig = config.get('logger');
    log4js.configure(loggerConfig);
    var loggerCategory = config.get('logger.levels.[all]');
    var logger = log4js.getLogger('User Controller');
    logger.info('Initialization info');
    logger.error('Initialization error');
    logger.debug('Initialization debug');
    process.on('uncaughtException', function (err) {
        var _loggerService = new LoggerService('uncaught exception Handler');
        var error = {
            reason: 'uncaught exception',
            message: err,
            stack: err.stack,
            code: 500
        };
        console.error(error);
        _loggerService.logError('Catching uncaught Exceptions. : ' + err);
        _loggerService.logError('Catching uncaught Exceptions stack : ' + err.stack);
        sharedService.mailToAdmin(error);
    });
    var syncAtEveryFifteenMinute = new CronJob('00 */5 * * * *', function () {
        var rateAnalysisServices = new RateAnalysisService();
        rateAnalysisServices.SyncRateAnalysis();
    }, function () {
        console.log('restart server');
    }, true);
    syncAtEveryFifteenMinute.start();
    var sendProjectExpiryWarningMail = new CronJob('01 0 0 * * *', function () {
        var userService = new UserService();
        var _loggerService = new LoggerService('uncaught exception Handler');
        userService.sendProjectExpiryWarningMails(function (error, success) {
            if (error) {
                _loggerService.logError('Error in sendProjectExpiryWarningMail for users : ' + error);
            }
            else {
                _loggerService.logDebug('ProjectExpiryWarningMail send successfully to all users.');
            }
        });
    }, function () {
        console.log('restart server');
    }, true);
    sendProjectExpiryWarningMail.start();
    if (mode === 'dev') {
        if (dist_runner === 'dist') {
            app.all('/*', function (req, res, next) {
                res.header('Access-Control-Allow-Origin', '*');
                res.header('Access-Control-Allow-Headers', 'X-Requested-With');
                next();
            });
            app.use(Middlewares.configuration);
            var root = path.resolve(process.cwd());
            var clientRoot = path.resolve(process.cwd(), './client/dev');
            app.use(express.static(root));
            app.use(express.static(clientRoot));
            _serverDir = '/dist/server/dev';
            app.use('/public', express.static(path.resolve(__dirname + _serverDir + '/public')));
            var renderIndex = function (req, res) {
                _clientDir = '/client/dev';
                res.sendFile(path.resolve(__dirname + _clientDir + '/index.html'));
            };
            app.get('/*', renderIndex);
        }
        else {
            app.all('/*', function (req, res, next) {
                res.header('Access-Control-Allow-Origin', '*');
                res.header('Access-Control-Allow-Headers', 'X-Requested-With');
                next();
            });
            app.use(Middlewares.configuration);
            var root = path.resolve(process.cwd());
            var clientRoot = path.resolve(process.cwd(), './dist/client/dev');
            app.use(express.static(root));
            app.use(express.static(clientRoot));
            _serverDir = '/dist/server/dev';
            app.use('/public', express.static(path.resolve(__dirname + _serverDir + '/public')));
            var renderIndex_1 = function (req, res) {
                _clientDir = '/dist/client/dev';
                res.sendFile(path.resolve(__dirname + _clientDir + '/index.html'));
            };
            app.get('/*', renderIndex_1);
        }
    }
    else {
        if (dist_runner === 'dist') {
            _clientDir = './client/prod';
            _serverDir = '/server/prod';
            app.use('/js', express.static(path.resolve(__dirname, _clientDir + '/js')));
            app.use('/css', express.static(path.resolve(__dirname, _clientDir + '/css')));
            app.use('/assets', express.static(path.resolve(__dirname, _clientDir + '/assets')));
            app.use('/banners', express.static(path.resolve(__dirname, _clientDir + '/banners')));
            app.use('/public', express.static(path.resolve(__dirname + _serverDir + '/public')));
            var renderIndex = function (req, res) {
                _clientDir = '/client/prod';
                res.sendFile(path.resolve(__dirname + _clientDir + '/index.html'));
            };
            app.get('/*', renderIndex);
        }
        else {
            app.use(Middlewares.configuration);
            _clientDir = './dist/client/prod';
            _serverDir = '/dist/server/prod';
            app.use('/js', express.static(path.resolve(__dirname, _clientDir + '/js')));
            app.use('/css', express.static(path.resolve(__dirname, _clientDir + '/css')));
            app.use('/assets', express.static(path.resolve(__dirname, _clientDir + '/assets')));
            app.use('/public', express.static(path.resolve(__dirname + _serverDir + '/public')));
            var renderIndex = function (req, res) {
                _clientDir = '/dist/client/prod';
                res.sendFile(path.resolve(__dirname + _clientDir + '/index.html'));
            };
            app.get('/*', renderIndex);
        }
    }
    if (protocol === 'http') {
        return new Promise(function (resolve, reject) {
            var server = app.listen(port, function () {
                var port = server.address().port;
                console.log('App is listening on port:' + port);
                resolve(server);
            });
            server.timeout = 600000;
        });
    }
    else {
        var options = {
            handshakeTimeout: 600000,
            passphrase: 'tpl123',
            spdy: {
                protocols: ['h2']
            }
        };
        return spdy.createServer(options, app)
            .listen(port, function (error) {
            if (error) {
                console.error(error);
                process.exit(1);
            }
            else {
                console.log('http2 Listening on port: ' + port + '.');
            }
        });
    }
}
exports.init = init;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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LElBQU0sT0FBTyxHQUFHO1lBR2QsZ0JBQWdCLEVBQUUsTUFBTTtZQUN4QixVQUFVLEVBQUUsUUFBUTtZQUNwQixJQUFJLEVBQUU7Z0JBQ0osU0FBUyxFQUFFLENBQUMsSUFBSSxDQUFDO2FBQ2xCO1NBQ0YsQ0FBQztRQUVGLE1BQU0sQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLE9BQU8sRUFBRSxHQUFHLENBQUM7YUFDbkMsTUFBTSxDQUFDLElBQUksRUFBRSxVQUFDLEtBQVU7WUFDdkIsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztnQkFDVixPQUFPLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFBO2dCQUVwQixPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ2xCLENBQUM7WUFBQyxJQUFJLENBQUMsQ0FBQztnQkFDTixPQUFPLENBQUMsR0FBRyxDQUFDLDJCQUEyQixHQUFHLElBQUksR0FBRyxHQUFHLENBQUMsQ0FBQztZQUN4RCxDQUFDO1FBQ0gsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDO0FBQ0gsQ0FBQztBQXRRRCxvQkFzUUMiLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBodHRwIGZyb20gJ2h0dHAnO1xyXG5pbXBvcnQgKiBhcyBleHByZXNzIGZyb20gJ2V4cHJlc3MnO1xyXG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnO1xyXG4vKmltcG9ydCAqIGFzIHJvdXRlcyBmcm9tIFwiLi9yb3V0ZXNcIjsqL1xyXG4vKmltcG9ydCAqIGFzIGNuZXh0Um91dGVzIGZyb20gXCIuL2NuZXh0LXJvdXRlc1wiOyovXHJcbmltcG9ydCAqIGFzIGZzIGZyb20gJ2ZzJztcclxuaW1wb3J0IExvZ2dlclNlcnZpY2UgPSByZXF1aXJlKCcuL2FwcC9mcmFtZXdvcmsvc2hhcmVkL2xvZ2dlci9Mb2dnZXJTZXJ2aWNlJyk7XHJcbmltcG9ydCAqIGFzIHNoYXJlZFNlcnZpY2UgZnJvbSAnLi9hcHAvZnJhbWV3b3JrL3NoYXJlZC9sb2dnZXIvc2hhcmVkLnNlcnZpY2UnO1xyXG5pbXBvcnQgTWlkZGxld2FyZXMgPSByZXF1aXJlKCcuL2FwcC9mcmFtZXdvcmsvbWlkZGxld2FyZXMvYmFzZS9NaWRkbGV3YXJlc0Jhc2UnKTtcclxuaW1wb3J0IFJhdGVBbmFseXNpcyA9IHJlcXVpcmUoJy4vYXBwL2FwcGxpY2F0aW9uUHJvamVjdC9kYXRhYWNjZXNzL21vZGVsL1JhdGVBbmFseXNpcy9SYXRlQW5hbHlzaXMnKTtcclxuaW1wb3J0IFJhdGVBbmFseXNpc1NlcnZpY2UgPSByZXF1aXJlKCcuL2FwcC9hcHBsaWNhdGlvblByb2plY3Qvc2VydmljZXMvUmF0ZUFuYWx5c2lzU2VydmljZScpO1xyXG5pbXBvcnQgVXNlclNlcnZpY2UgPSByZXF1aXJlKCcuL2FwcC9mcmFtZXdvcmsvc2VydmljZXMvVXNlclNlcnZpY2UnKTtcclxudmFyIGxvZzRqcyA9IHJlcXVpcmUoJ2xvZzRqcycpO1xyXG52YXIgY29uZmlnID0gcmVxdWlyZSgnY29uZmlnJyk7XHJcbi8qdmFyIGxvZ0RpciA9ICdMb2dzJzsqL1xyXG5cclxudmFyIHNwZHkgPSByZXF1aXJlKCdzcGR5Jyk7XHJcbl9fZGlybmFtZSA9ICcuLyc7XHJcbnZhciBfY2xpZW50RGlyID0gJy9kaXN0L2NsaWVudC9kZXYnO1xyXG52YXIgX3NlcnZlckRpciA9ICcvZGlzdC9zZXJ2ZXIvZGV2JztcclxudmFyIGFwcCA9IGV4cHJlc3MoKTtcclxudmFyIENyb25Kb2IgPSByZXF1aXJlKCdjcm9uJykuQ3JvbkpvYjtcclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBpbml0KHBvcnQ6IG51bWJlciwgbW9kZTogc3RyaW5nLCBwcm90b2NvbDogc3RyaW5nLCBkaXN0X3J1bm5lcjogc3RyaW5nKSB7XHJcblxyXG5cclxuXHJcblxyXG5cclxuICB2YXIgbG9nZ2VyQ29uZmlnPWNvbmZpZy5nZXQoJ2xvZ2dlcicpO1xyXG5cclxuICBsb2c0anMuY29uZmlndXJlKGxvZ2dlckNvbmZpZyk7XHJcbiAgdmFyIGxvZ2dlckNhdGVnb3J5ID1jb25maWcuZ2V0KCdsb2dnZXIubGV2ZWxzLlthbGxdJylcclxuICB2YXIgbG9nZ2VyPWxvZzRqcy5nZXRMb2dnZXIoJ1VzZXIgQ29udHJvbGxlcicpO1xyXG4gIGxvZ2dlci5pbmZvKCdJbml0aWFsaXphdGlvbiBpbmZvJyk7XHJcbiAgbG9nZ2VyLmVycm9yKCdJbml0aWFsaXphdGlvbiBlcnJvcicpO1xyXG4gIGxvZ2dlci5kZWJ1ZygnSW5pdGlhbGl6YXRpb24gZGVidWcnKTtcclxuXHJcblxyXG5cclxuICBwcm9jZXNzLm9uKCd1bmNhdWdodEV4Y2VwdGlvbicsIGZ1bmN0aW9uIChlcnI6YW55KSB7XHJcbiAgICBsZXQgX2xvZ2dlclNlcnZpY2U6IExvZ2dlclNlcnZpY2UgPSBuZXcgTG9nZ2VyU2VydmljZSgndW5jYXVnaHQgZXhjZXB0aW9uIEhhbmRsZXInKTtcclxuICAgIGxldCBlcnJvcj0ge1xyXG4gICAgICByZWFzb246ICd1bmNhdWdodCBleGNlcHRpb24nLFxyXG4gICAgICBtZXNzYWdlOiBlcnIsXHJcbiAgICAgIHN0YWNrOiBlcnIuc3RhY2ssXHJcbiAgICAgIGNvZGU6IDUwMFxyXG4gICAgfTtcclxuICAgIGNvbnNvbGUuZXJyb3IoZXJyb3IpO1xyXG4gICAgX2xvZ2dlclNlcnZpY2UubG9nRXJyb3IoJ0NhdGNoaW5nIHVuY2F1Z2h0IEV4Y2VwdGlvbnMuIDogJyArZXJyKTtcclxuICAgIF9sb2dnZXJTZXJ2aWNlLmxvZ0Vycm9yKCdDYXRjaGluZyB1bmNhdWdodCBFeGNlcHRpb25zIHN0YWNrIDogJyArZXJyLnN0YWNrKTtcclxuICAgIC8vc2hhcmVkU2VydmljZS5lcnJvckhhbmRsZXIoZXJyb3IpO1xyXG4gICAgc2hhcmVkU2VydmljZS5tYWlsVG9BZG1pbihlcnJvcik7XHJcbiAgfSk7XHJcblxyXG4gIGxldCBzeW5jQXRFdmVyeUZpZnRlZW5NaW51dGUgPSBuZXcgQ3JvbkpvYignMDAgKi81ICogKiAqIConLCBmdW5jdGlvbigpIHtcclxuICAgICAgbGV0IHJhdGVBbmFseXNpc1NlcnZpY2VzOiBSYXRlQW5hbHlzaXNTZXJ2aWNlID0gbmV3IFJhdGVBbmFseXNpc1NlcnZpY2UoKTtcclxuICAgICAgcmF0ZUFuYWx5c2lzU2VydmljZXMuU3luY1JhdGVBbmFseXNpcygpO1xyXG4gICAgfSwgZnVuY3Rpb24gKCkge1xyXG4gICAgICBjb25zb2xlLmxvZygncmVzdGFydCBzZXJ2ZXInKTtcclxuICAgIH0sXHJcbiAgICB0cnVlXHJcbiAgKTtcclxuICBzeW5jQXRFdmVyeUZpZnRlZW5NaW51dGUuc3RhcnQoKTtcclxuXHJcblxyXG4gIC8vbGV0IHNlbmRQcm9qZWN0RXhwaXJ5V2FybmluZ01haWwgPSBuZXcgQ3JvbkpvYignMDAgKi81IDAgKiAqIConLCBmdW5jdGlvbigpIHtcclxuICBsZXQgc2VuZFByb2plY3RFeHBpcnlXYXJuaW5nTWFpbCA9IG5ldyBDcm9uSm9iKCcwMSAwIDAgKiAqIConLCBmdW5jdGlvbigpIHtcclxuICAgICAgbGV0IHVzZXJTZXJ2aWNlIDogVXNlclNlcnZpY2UgPSBuZXcgVXNlclNlcnZpY2UoKTtcclxuICAgICAgbGV0IF9sb2dnZXJTZXJ2aWNlOiBMb2dnZXJTZXJ2aWNlID0gbmV3IExvZ2dlclNlcnZpY2UoJ3VuY2F1Z2h0IGV4Y2VwdGlvbiBIYW5kbGVyJyk7XHJcbiAgICAgIHVzZXJTZXJ2aWNlLnNlbmRQcm9qZWN0RXhwaXJ5V2FybmluZ01haWxzKChlcnJvciwgc3VjY2VzcykgPT4ge1xyXG4gICAgICAgIGlmKGVycm9yKSB7XHJcbiAgICAgICAgICBfbG9nZ2VyU2VydmljZS5sb2dFcnJvcignRXJyb3IgaW4gc2VuZFByb2plY3RFeHBpcnlXYXJuaW5nTWFpbCBmb3IgdXNlcnMgOiAnICtlcnJvcik7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIF9sb2dnZXJTZXJ2aWNlLmxvZ0RlYnVnKCdQcm9qZWN0RXhwaXJ5V2FybmluZ01haWwgc2VuZCBzdWNjZXNzZnVsbHkgdG8gYWxsIHVzZXJzLicpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICB9LCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgIGNvbnNvbGUubG9nKCdyZXN0YXJ0IHNlcnZlcicpO1xyXG4gICAgfSxcclxuICAgIHRydWVcclxuICApO1xyXG5cclxuICBzZW5kUHJvamVjdEV4cGlyeVdhcm5pbmdNYWlsLnN0YXJ0KCk7XHJcbiAgLy9sb2dnZXIgbG9nNGpzIGluaXRpYWxpemF0aW9uXHJcbiAgLypcclxuICAgIGNvbnNvbGUubG9nKCdMb2dnZXIgSW5pdGlhbGl6YXRpb24nKTtcclxuXHJcbiAgIHZhciBsb2dDb25maWc9Y29uZmlnLmdldCgnbG9nZ2VyJyk7XHJcblxyXG4gICAgY29uc29sZS5sb2coJ0xvZ2dlciBJbml0aWFsaXphdGlvbiAxJyk7XHJcblxyXG4gICB2YXIgbG9nZ2VyTGV2ZWw9Y29uZmlnLmdldCgnbG9nZ2VyLmxldmVscy5bYWxsXScpO1xyXG5cclxuICAgIGNvbnNvbGUubG9nKCdMb2dnZXIgSW5pdGlhbGl6YXRpb24gMicpO1xyXG5cclxuICAgIHZhciBsb2dnZXIgPSBsb2c0anMuZ2V0TG9nZ2VyKGxvZ2dlckxldmVsKTsgLy8gaW5pdGlhbGl6ZSB0aGUgdmFyIHRvIHVzZS5cclxuXHJcbiAgICBjb25zb2xlLmxvZygnTG9nZ2VyIEluaXRpYWxpemF0aW9uIGNvbXBsZXRlZCcpO1xyXG5cclxuICAgIGxvZ2dlci5pbmZvKCdUaGlzIGlzIEluZm9ybWF0aW9uIExvZ2dlcicpO1xyXG4gICAgbG9nZ2VyLmVycm9yKCdUaGlzIGlzIEVycm9yIExvZ2dlcicpO1xyXG4gICAgbG9nZ2VyLmRlYnVnKCdUaGlzIGlzIERlYnVnZ2VyJyk7XHJcblxyXG4gICAgY29uc29sZS5sb2coJ0xvZ2dlciBhcHBlbmRlZCBpbiBmaWxlJyk7Ki9cclxuICAvKipcclxuICAgKiBEZXYgTW9kZS5cclxuICAgKiBAbm90ZSBEZXYgc2VydmVyIHdpbGwgb25seSBnaXZlIGZvciB5b3UgbWlkZGxld2FyZS5cclxuICAgKi9cclxuICBpZiAobW9kZSA9PT0gJ2RldicpIHtcclxuICAgIGlmIChkaXN0X3J1bm5lciA9PT0gJ2Rpc3QnKSB7XHJcbiAgICAgIGFwcC5hbGwoJy8qJywgZnVuY3Rpb24gKHJlcSwgcmVzLCBuZXh0KSB7XHJcbiAgICAgICAgcmVzLmhlYWRlcignQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luJywgJyonKTtcclxuICAgICAgICByZXMuaGVhZGVyKCdBY2Nlc3MtQ29udHJvbC1BbGxvdy1IZWFkZXJzJywgJ1gtUmVxdWVzdGVkLVdpdGgnKTtcclxuICAgICAgICBuZXh0KCk7XHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgYXBwLnVzZShNaWRkbGV3YXJlcy5jb25maWd1cmF0aW9uKTtcclxuXHJcbiAgICAgIGxldCByb290ID0gcGF0aC5yZXNvbHZlKHByb2Nlc3MuY3dkKCkpO1xyXG4gICAgICBsZXQgY2xpZW50Um9vdCA9IHBhdGgucmVzb2x2ZShwcm9jZXNzLmN3ZCgpLCAnLi9jbGllbnQvZGV2Jyk7XHJcbiAgICAgIGFwcC51c2UoZXhwcmVzcy5zdGF0aWMocm9vdCkpO1xyXG4gICAgICBhcHAudXNlKGV4cHJlc3Muc3RhdGljKGNsaWVudFJvb3QpKTtcclxuICAgICAgX3NlcnZlckRpciA9ICcvZGlzdC9zZXJ2ZXIvZGV2JztcclxuICAgICAgYXBwLnVzZSgnL3B1YmxpYycsIGV4cHJlc3Muc3RhdGljKHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUgKyBfc2VydmVyRGlyICsnL3B1YmxpYycpKSk7XHJcbiAgICAgIHZhciByZW5kZXJJbmRleCA9IChyZXE6IGV4cHJlc3MuUmVxdWVzdCwgcmVzOiBleHByZXNzLlJlc3BvbnNlKSA9PiB7XHJcbiAgICAgICAgX2NsaWVudERpciA9ICcvY2xpZW50L2Rldic7XHJcbiAgICAgICAgcmVzLnNlbmRGaWxlKHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUgKyBfY2xpZW50RGlyICsgJy9pbmRleC5odG1sJykpO1xyXG4gICAgICB9O1xyXG4gICAgICBhcHAuZ2V0KCcvKicsIHJlbmRlckluZGV4KTtcclxuICAgICAgLyoqXHJcbiAgICAgICAqIEFwaSBSb3V0ZXMgZm9yIGBEZXZlbG9wbWVudGAuXHJcbiAgICAgICAqL1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgYXBwLmFsbCgnLyonLCBmdW5jdGlvbiAocmVxLCByZXMsIG5leHQpIHtcclxuICAgICAgICByZXMuaGVhZGVyKCdBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW4nLCAnKicpO1xyXG4gICAgICAgIHJlcy5oZWFkZXIoJ0FjY2Vzcy1Db250cm9sLUFsbG93LUhlYWRlcnMnLCAnWC1SZXF1ZXN0ZWQtV2l0aCcpO1xyXG4gICAgICAgIG5leHQoKTtcclxuICAgICAgfSk7XHJcblxyXG4gICAgICAvKnJvdXRlcy5pbml0KGFwcCk7Ki9cclxuICAgICAgYXBwLnVzZShNaWRkbGV3YXJlcy5jb25maWd1cmF0aW9uKTtcclxuICAgICAgLy9jbmV4dFJvdXRlcy5jbmV4dEluaXQoYXBwKTtcclxuXHJcbiAgICAgIGxldCByb290ID0gcGF0aC5yZXNvbHZlKHByb2Nlc3MuY3dkKCkpO1xyXG4gICAgICBsZXQgY2xpZW50Um9vdCA9IHBhdGgucmVzb2x2ZShwcm9jZXNzLmN3ZCgpLCAnLi9kaXN0L2NsaWVudC9kZXYnKTtcclxuICAgICAgYXBwLnVzZShleHByZXNzLnN0YXRpYyhyb290KSk7XHJcbiAgICAgIGFwcC51c2UoZXhwcmVzcy5zdGF0aWMoY2xpZW50Um9vdCkpO1xyXG4gICAgICBfc2VydmVyRGlyID0gJy9kaXN0L3NlcnZlci9kZXYnO1xyXG4gICAgICBhcHAudXNlKCcvcHVibGljJywgZXhwcmVzcy5zdGF0aWMocGF0aC5yZXNvbHZlKF9fZGlybmFtZSsgX3NlcnZlckRpciArJy9wdWJsaWMnKSkpO1xyXG4gICAgICBsZXQgcmVuZGVySW5kZXggPSAocmVxOiBleHByZXNzLlJlcXVlc3QsIHJlczogZXhwcmVzcy5SZXNwb25zZSkgPT4ge1xyXG4gICAgICAgIF9jbGllbnREaXIgPSAnL2Rpc3QvY2xpZW50L2Rldic7XHJcbiAgICAgICAgcmVzLnNlbmRGaWxlKHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUgKyBfY2xpZW50RGlyICsgJy9pbmRleC5odG1sJykpO1xyXG4gICAgICB9O1xyXG4gICAgICBhcHAuZ2V0KCcvKicsIHJlbmRlckluZGV4KTtcclxuICAgICAgLyoqXHJcbiAgICAgICAqIEFwaSBSb3V0ZXMgZm9yIGBEZXZlbG9wbWVudGAuXHJcbiAgICAgICAqL1xyXG4gICAgfVxyXG4gIH0gZWxzZSB7XHJcbiAgICBpZihkaXN0X3J1bm5lciA9PT0gJ2Rpc3QnKSB7XHJcbiAgICAgIC8qKlxyXG4gICAgICAgKiBQcm9kIE1vZGUuXHJcbiAgICAgICAqIEBub3RlIFByb2QgbW9kIHdpbGwgZ2l2ZSB5b3Ugc3RhdGljICsgbWlkZGxld2FyZS5cclxuICAgICAgICovXHJcblxyXG4gICAgICAvKipcclxuICAgICAgICogQXBpIFJvdXRlcyBmb3IgYFByb2R1Y3Rpb25gLlxyXG4gICAgICAgKi9cclxuICAgICAgLypyb3V0ZXMuaW5pdChhcHApOyovXHJcbiAgICAgIC8qY25leHRSb3V0ZXMuY25leHRJbml0KGFwcCk7Ki9cclxuICAgICAgLyoqXHJcbiAgICAgICAqIENsaWVudCBEaXJcclxuICAgICAgICovXHJcbiAgICAgIF9jbGllbnREaXIgPSAnLi9jbGllbnQvcHJvZCc7XHJcbiAgICAgIF9zZXJ2ZXJEaXIgPSAnL3NlcnZlci9wcm9kJztcclxuXHJcbiAgICAgIC8qKlxyXG4gICAgICAgKiBTdGF0aWMuXHJcbiAgICAgICAqL1xyXG4gICAgICBhcHAudXNlKCcvanMnLCBleHByZXNzLnN0YXRpYyhwYXRoLnJlc29sdmUoX19kaXJuYW1lLCBfY2xpZW50RGlyICsgJy9qcycpKSk7XHJcbiAgICAgIGFwcC51c2UoJy9jc3MnLCBleHByZXNzLnN0YXRpYyhwYXRoLnJlc29sdmUoX19kaXJuYW1lLCBfY2xpZW50RGlyICsgJy9jc3MnKSkpO1xyXG4gICAgICBhcHAudXNlKCcvYXNzZXRzJywgZXhwcmVzcy5zdGF0aWMocGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgX2NsaWVudERpciArICcvYXNzZXRzJykpKTtcclxuICAgICAgYXBwLnVzZSgnL2Jhbm5lcnMnLCBleHByZXNzLnN0YXRpYyhwYXRoLnJlc29sdmUoX19kaXJuYW1lLCBfY2xpZW50RGlyICsgJy9iYW5uZXJzJykpKTtcclxuICAgICAgYXBwLnVzZSgnL3B1YmxpYycsIGV4cHJlc3Muc3RhdGljKHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUrIF9zZXJ2ZXJEaXIgKyAnL3B1YmxpYycpKSk7XHJcblxyXG5cclxuICAgICAgLyoqXHJcbiAgICAgICAqIFNwYSBSZXMgU2VuZGVyLlxyXG4gICAgICAgKiBAcGFyYW0gcmVxIHthbnl9XHJcbiAgICAgICAqIEBwYXJhbSByZXMge2FueX1cclxuICAgICAgICovXHJcbiAgICAgIHZhciByZW5kZXJJbmRleCA9IGZ1bmN0aW9uIChyZXE6IGV4cHJlc3MuUmVxdWVzdCwgcmVzOiBleHByZXNzLlJlc3BvbnNlKSB7XHJcbiAgICAgICAgX2NsaWVudERpciA9ICcvY2xpZW50L3Byb2QnO1xyXG4gICAgICAgIHJlcy5zZW5kRmlsZShwYXRoLnJlc29sdmUoX19kaXJuYW1lICsgX2NsaWVudERpciArICcvaW5kZXguaHRtbCcpKTtcclxuICAgICAgfTtcclxuXHJcbiAgICAgIC8vYXBwLmdldCgnKicsIGZ1bmN0aW9uKHJlcSxyZXMpIHtcclxuICAgICAgLy8gIHJlcy5zZW5kRmlsZShwcm9jZXNzLmN3ZCgpICsgJy9kaXN0L3Byb2QvY2xpZW50L2luZGV4Lmh0bWwnKTtcclxuICAgICAgLy99KTtcclxuXHJcbiAgICAgIC8qKlxyXG4gICAgICAgKiBQcmV2ZW50IHNlcnZlciByb3V0aW5nIGFuZCB1c2UgQG5nMi1yb3V0ZXIuXHJcbiAgICAgICAqL1xyXG4gICAgICBhcHAuZ2V0KCcvKicsIHJlbmRlckluZGV4KTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIC8qKlxyXG4gICAgICAgKiBQcm9kIE1vZGUuXHJcbiAgICAgICAqIEBub3RlIFByb2QgbW9kIHdpbGwgZ2l2ZSB5b3Ugc3RhdGljICsgbWlkZGxld2FyZS5cclxuICAgICAgICovXHJcblxyXG4gICAgICAvKipcclxuICAgICAgICogQXBpIFJvdXRlcyBmb3IgYFByb2R1Y3Rpb25gLlxyXG4gICAgICAgKi9cclxuICAgICAgYXBwLnVzZShNaWRkbGV3YXJlcy5jb25maWd1cmF0aW9uKTtcclxuICAgICAgLyoqXHJcbiAgICAgICAqIENsaWVudCBEaXJcclxuICAgICAgICovXHJcbiAgICAgIF9jbGllbnREaXIgPSAnLi9kaXN0L2NsaWVudC9wcm9kJztcclxuICAgICAgX3NlcnZlckRpciA9ICcvZGlzdC9zZXJ2ZXIvcHJvZCc7XHJcblxyXG4gICAgICAvKipcclxuICAgICAgICogU3RhdGljLlxyXG4gICAgICAgKi9cclxuICAgICAgYXBwLnVzZSgnL2pzJywgZXhwcmVzcy5zdGF0aWMocGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgX2NsaWVudERpciArICcvanMnKSkpO1xyXG4gICAgICBhcHAudXNlKCcvY3NzJywgZXhwcmVzcy5zdGF0aWMocGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgX2NsaWVudERpciArICcvY3NzJykpKTtcclxuICAgICAgYXBwLnVzZSgnL2Fzc2V0cycsIGV4cHJlc3Muc3RhdGljKHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsIF9jbGllbnREaXIgKyAnL2Fzc2V0cycpKSk7XHJcbiAgICAgIGFwcC51c2UoJy9wdWJsaWMnLCBleHByZXNzLnN0YXRpYyhwYXRoLnJlc29sdmUoX19kaXJuYW1lKyBfc2VydmVyRGlyKycvcHVibGljJykpKTtcclxuXHJcbiAgICAgIC8qKlxyXG4gICAgICAgKiBTcGEgUmVzIFNlbmRlci5cclxuICAgICAgICogQHBhcmFtIHJlcSB7YW55fVxyXG4gICAgICAgKiBAcGFyYW0gcmVzIHthbnl9XHJcbiAgICAgICAqL1xyXG4gICAgICB2YXIgcmVuZGVySW5kZXggPSBmdW5jdGlvbiAocmVxOiBleHByZXNzLlJlcXVlc3QsIHJlczogZXhwcmVzcy5SZXNwb25zZSkge1xyXG4gICAgICAgIF9jbGllbnREaXIgPSAnL2Rpc3QvY2xpZW50L3Byb2QnO1xyXG4gICAgICAgIHJlcy5zZW5kRmlsZShwYXRoLnJlc29sdmUoX19kaXJuYW1lICsgX2NsaWVudERpciArICcvaW5kZXguaHRtbCcpKTtcclxuICAgICAgfTtcclxuXHJcbiAgICAgIC8vYXBwLmdldCgnKicsIGZ1bmN0aW9uKHJlcSxyZXMpIHtcclxuICAgICAgLy8gIHJlcy5zZW5kRmlsZShwcm9jZXNzLmN3ZCgpICsgJy9kaXN0L3Byb2QvY2xpZW50L2luZGV4Lmh0bWwnKTtcclxuICAgICAgLy99KTtcclxuXHJcbiAgICAgIC8qKlxyXG4gICAgICAgKiBQcmV2ZW50IHNlcnZlciByb3V0aW5nIGFuZCB1c2UgQG5nMi1yb3V0ZXIuXHJcbiAgICAgICAqL1xyXG4gICAgICBhcHAuZ2V0KCcvKicsIHJlbmRlckluZGV4KTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFNlcnZlciB3aXRoIGd6aXAgY29tcHJlc3Npb24uXHJcbiAgICovXHJcbiAgLy9IVFRQIFNUQVJUOlxyXG4gIGlmIChwcm90b2NvbCA9PT0gJ2h0dHAnKSB7XHJcbiAgICByZXR1cm4gbmV3IFByb21pc2U8aHR0cC5TZXJ2ZXI+KChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgbGV0IHNlcnZlciA9IGFwcC5saXN0ZW4ocG9ydCwgKCkgPT4ge1xyXG4gICAgICAgIHZhciBwb3J0ID0gc2VydmVyLmFkZHJlc3MoKS5wb3J0O1xyXG4gICAgICAgIGNvbnNvbGUubG9nKCdBcHAgaXMgbGlzdGVuaW5nIG9uIHBvcnQ6JyArIHBvcnQpO1xyXG4gICAgICAgIHJlc29sdmUoc2VydmVyKTtcclxuICAgICAgfSk7XHJcbiAgICAgIHNlcnZlci50aW1lb3V0ID0gNjAwMDAwOyAvL2J5IGRlZmF1bHQgdGltZW91dCBzZXQgdG8gMTAgbWluIGZvciBleHBvcnQgZnVuY3Rpb25hbGl0eVxyXG4gICAgfSk7XHJcbiAgfSBlbHNlIHtcclxuICAgIGNvbnN0IG9wdGlvbnMgPSB7XHJcbiAgICAgIC8vIGtleTogZnMucmVhZEZpbGVTeW5jKCcuL3N0YWdpbmcuam9ibW9zaXMuY29tLmtleScpLFxyXG4gICAgICAvLyBjZXJ0OiBmcy5yZWFkRmlsZVN5bmMoJy4vc3RhZ2luZy5qb2Jtb3Npcy5jb20uY3J0JyksXHJcbiAgICAgIGhhbmRzaGFrZVRpbWVvdXQ6IDYwMDAwMCwgLy9ieSBkZWZhdWx0IHRpbWVvdXQgc2V0IHRvIDEwIG1pbiBmb3IgZXhwb3J0IGZ1bmN0aW9uYWxpdHksIE5lZWQgdG8gdGVzdCB0aGlzXHJcbiAgICAgIHBhc3NwaHJhc2U6ICd0cGwxMjMnLFxyXG4gICAgICBzcGR5OiB7XHJcbiAgICAgICAgcHJvdG9jb2xzOiBbJ2gyJ11cclxuICAgICAgfVxyXG4gICAgfTtcclxuXHJcbiAgICByZXR1cm4gc3BkeS5jcmVhdGVTZXJ2ZXIob3B0aW9ucywgYXBwKVxyXG4gICAgICAubGlzdGVuKHBvcnQsIChlcnJvcjogYW55KSA9PiB7XHJcbiAgICAgICAgaWYgKGVycm9yKSB7XHJcbiAgICAgICAgICBjb25zb2xlLmVycm9yKGVycm9yKVxyXG4gICAgICAgICAgLy8gcmV0dXJuIHByb2Nlc3MuZXhpdCgxKTtcclxuICAgICAgICAgIHByb2Nlc3MuZXhpdCgxKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgY29uc29sZS5sb2coJ2h0dHAyIExpc3RlbmluZyBvbiBwb3J0OiAnICsgcG9ydCArICcuJyk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICB9XHJcbn1cclxuIl19
